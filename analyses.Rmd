---
title: "childes_weird"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE)
```



```{r libraries, message=FALSE, warning=FALSE}


#devtools::install_github("unDocUMeantIt/koRpus.lang.fr") # stable release


#library(childesr)
#library(wordbankr)
library(ggplot2)
library(dplyr)
library(tidyr)
library(purrr)
require(scales)
library(stringr)
library(kableExtra)
library(ggpubr)


library(RColorBrewer)
myPalette <- brewer.pal(5, "Set2") 


group_count <-function(data_, column_){
data_<- data_ %>%
  group_by({{column_}}) %>%
    count() 
      return(data_)
}

group_select<-function(data_, column_){
data_ <- data_%>%
    group_by(!!column_) %>%
      select(Corpus, !!column_)
data_ <- data_[ order( data_[,3] ),]
return(data_)
}
```

# Load annotations 

```{r load annotations}

annotations<- read.csv("Table for authors - annotations.csv") 
colnames(annotations)[colnames(annotations)=="X..of.children.with.siblings"]<-"Nb.of.children.with.siblings"
colnames(annotations)[colnames(annotations)=="X..of.children.with.older.siblings"]<-"Nb.of.children.with.older.siblings"
colnames(annotations)=gsub("\\.\\..*","",colnames(annotations))
colnames(annotations)[colnames(annotations)=="Our.coding.of"]<-"Our.coding.of.community.type"

annotations$Number.of.participants[annotations$Number.of.participants=="1 or 5"]<-NA
annotations$Number.of.participants[annotations$Number.of.participants=="1 CHI + MOT/FAT/INV"]<-1
annotations$Number.of.participants[annotations$Number.of.participants=="4 CHI + MOTs, some FATs, some SIBs"]<-4
annotations$Number.of.participants=as.numeric(as.character(annotations$Number.of.participants))

annotations$Nb.of.children.with.siblings=as.numeric(as.character(annotations$Nb.of.children.with.siblings))

annotations$Proportion.With.Siblings=annotations$Nb.of.children.with.siblings/annotations$Number.of.participants

#table(annotations$Household.structure)
annotations$Household.structure=tolower(annotations$Household.structure)
annotations$Household.structure[grep("different|diverse|varied",annotations$Household.structure)] <- NA #turn to NA?
annotations$Household.structure[annotations$Household.structure %in% c("nuclear, extended","extended/nuclear")]<-"varied"
annotations$Household.structure[grep("nuclear|nucear|single",annotations$Household.structure)]<-"nuclear" # including single parent
annotations$Household.structure[grep("extended",annotations$Household.structure)]<-"extended"
annotations$Household.structure[annotations$Household.structure==""]<-NA


# Education & SES cleaning
annotations$Education.Naomi[annotations$Education.Naomi==""]<-NA
annotations$Education.Naomi[annotations$Education.Naomi=="4-6"]<-"4-5" #fix typo
annotations$Education.min<-as.numeric(as.character(gsub("-.*","",annotations$Education.Naomi)))
annotations$Education.max<-as.numeric(as.character(gsub(".*-","",annotations$Education.Naomi)))
annotations$Education.mid<-annotations$Education.min+(annotations$Education.max-annotations$Education.min)/2
# 1 = primary
# 2 = secondary school
# 3 = some college
# 4 = university
# 5 = postgraduate
annotations$SES.Naomi[annotations$SES.Naomi==""]<-NA
annotations$SES.min<-gsub("-.*","",annotations$SES.Naomi)
annotations$SES.max<-gsub(".*-","",annotations$SES.Naomi)
annotations$SES.max[grep("upper",annotations$Parental.socioeconomic.status)]<-3




annotations$SES.mid<-as.numeric(as.character(annotations$SES.min))+(as.numeric(as.character(annotations$SES.max))-as.numeric(as.character(annotations$SES.min)))/2


```







```{r group_by inclusion}

# include<- annotations %>%
#   mutate(inclusion=tolower(Inclusion)) %>%
#   mutate(inclusion = ifelse(str_detect(inclusion, "yes"), "yes", "no")) %>%
#   group_by(inclusion) %>%
#   count() 

# ggplot(include,aes(y=n, x=inclusion)) +
#   geom_bar(stat="identity", width=1, color="white") +
#   theme_minimal() + 
#   ggtitle("Corpus inclusion") 

all_annotations <- annotations

annotations <- all_annotations %>%
  filter(Inclusion=="yes")


all_annotations$why.exclude<-NA
#all_annotations$why.exclude[all_annotations$Reason.for.exclusion %in% ]

```


A total of `r nrow(all_annotations)` corpora were considered.  From the total amount of corpora, `r nrow(annotations)` have been included in this study. The following analyses will continue only on these included corpora.



```{r group_by location_cleaning}

annotations$country <-NA
annotations$continent <-NA


annotations$country[grep("Ireland", annotations$Location)]  <- "Ireland"
annotations$country[grep("England|Arfon area Gwynedd, North Wales|Belfast, Northern Ireland|Nottingham/Manchester, England|England, Brighton|Wales", annotations$Location)]  <- "United Kingdom"
annotations$country[grep("Portugal", annotations$Location)]  <- "Portugal"
annotations$country[grep("Spain|Madrid, Spain ; Tenerife, Canary Islands|Madrid, Spain|Navarra, Spain|Alt penedes, region of catalonia|spain| Lloret de mar|Barcelona| SPAIN|Salamanca|Lugo", annotations$Location)]  <- "Spain"
annotations$country[grep("France|France (Normandy, Marseille, + places visited)", annotations$Location)]  <- "France"
annotations$country[grep("Naples|italy|Roma", annotations$Location)]  <- "Italy"
annotations$country[grep("Switzerland", annotations$Location)]  <- "Switzerland"
annotations$country[grep("Belgium", annotations$Location)]  <- "Belgium"
annotations$country[grep("Germany", annotations$Location)]  <- "Germany"
annotations$country[grep("Netherlands", annotations$Location)]  <- "Netherlands"

#Following the EuroVoc classification https://en.wikipedia.org/wiki/EuroVoc + Italy and Spain and Portugal
annotations$continent[grep("Andorra|Austria|Belgium|France|Germany|Ireland|Italy|Liechtenstein|Luxembourg|Monaco|Netherlands|Portugal|Spain|Switzerland|United Kingdom", annotations$country)]  <- "Western Europe"


annotations$country[grep("Poznań, Poland", annotations$Location)]  <- "Poland"
annotations$country[grep("Estonia|Tartu, Estonia ; Rapla, Estonia|Southern Estonia|Tartu, Estonia", annotations$Location)]  <- "Estonia"
annotations$country[grep("Hungary", annotations$Location)]  <- "Hungary"
annotations$country[grep("Czech Republic", annotations$Location)]  <- "Czech Republic"
annotations$country[grep("Bucharest, Romania|Romania", annotations$Location)]  <- "Romania"
annotations$country[grep("Serbia", annotations$Location)]  <- "Serbia"
annotations$country[grep("Croatia", annotations$Location)]  <- "Croatia"
annotations$country[grep("Slovenia", annotations$Location)]  <- "Slovenia"

annotations$country[grep("Sweden", annotations$Location)]  <- "Sweden"
annotations$country[grep("Iceland", annotations$Location)]  <- "Iceland"
annotations$country[grep("Norway", annotations$Location)]  <- "Norway"
annotations$country[grep("Denmark", annotations$Location)]  <- "Denmark"

annotations$country[grep("Athens, Greece", annotations$Location)]  <- "Greece"

annotations$country[grep("Moscow, Russia", annotations$Location)]  <- "Russia"

annotations$continent[grep("Poland|Estonia|Hungary|Czech|Romania|Serbia|Croatia|Slovenia|Sweden|Iceland|Norway|Denmark|Greece|Russia", annotations$country)]  <- "Non-Western Europe"


annotations$country[grep("Turkey", annotations$Location)]  <- "Turkey"
annotations$country[grep("Iran", annotations$Location)]  <- "Iran"
annotations$country[grep("Israel|Yahud, Israel", annotations$Location)]  <- "Israel"
annotations$country[grep("Kuwait", annotations$Location)]  <- "Kuwait"

annotations$country[grep("Bombay, India", annotations$Location)]  <- "India"

annotations$country[grep("China", annotations$Location)]  <- "China"

annotations$country[grep("Singapore", annotations$Location)]  <- "Singapore"
annotations$country[grep("Indonesia", annotations$Location)]  <- "Indonesia"
annotations$country[grep("Bangkok, Thailand", annotations$Location)]  <- "Thailand"
annotations$country[grep("Osaka|Tokyo|Nagoya|osaka|Kusatsu City, Shiga Pref", annotations$Location)]  <- "Japan"
annotations$country[grep("Korea", annotations$Location)]  <- "Korea" #NOTE: one corpus just says "Korea", data collected in 2009-2011, assuming it's South Korean
annotations$country[grep("Hong-Kong", annotations$Location)]  <- "Hong Kong"
annotations$country[grep("Taiwan", annotations$Location)]  <- "Taiwan"

annotations$continent[grep("Turkey|Iran|Israel|Kuwait|India|China|Singapore|Indonesia|Thailand|Japan|Korea|Hong Kong|Taiwan", annotations$country)]  <- "Asia"


annotations$country[grep("Papua-New Guinea", annotations$Location)]  <- "Papua New Guinea"
annotations$continent[grep("Papua New Guinea", annotations$country)]  <- "Oceania"


annotations$country[grep("Alexandria, Egypt", annotations$Location)]  <- "Egypt"
annotations$country[grep("Mokhotlong, Lesotho", annotations$Location)]  <- "Lesotho"
annotations$country[grep("South Africa", annotations$Location)]  <- "South Africa"
annotations$continent[grep("Egypt|Lesotho|Africa", annotations$country)]  <- "Africa"


annotations$country[grep("Rio Cuarto, Cordoba, Argentina", annotations$Location)]  <- "Argentina"
annotations$country[grep("Sao Paulo", annotations$Location)]  <- "Brazil"
annotations$country[grep("Mexico", annotations$Location)]  <- "Mexico"
annotations$country[grep("Jamaica", annotations$Location)]  <- "Jamaica"
annotations$continent[grep("Argentina|Brazil|Mexico|Jamaica", annotations$country)]  <- "Latin America"

annotations$country[grep("Michigan, USA|USA, Northern Virginia|California, USA|washington dc|United States|USA|Washington|Maryland|San Fran", annotations$Location)]  <- "United States"
annotations$country[grep("Canada", annotations$Location)]  <- "Canada"
annotations$continent[grep("United States|Canada", annotations$country)]  <- "North America"


#Special cases
annotations$country[grep("Sweden ; Portugal", annotations$Location)]  <- "Sweden & Portugal"
annotations$country[grep("Spain (Lloret de Mar), Hungary (Kecskemét)", annotations$Location)]  <- "Spain & Hungary"
#We are leaving continent as NA (because one country is Western & the other Eastern Europe)


#to check if any left
#annotations[is.na(annotations$country),"Location"]
#annotations[is.na(annotations$continent),"Location"]





```

```{r cleaning type}

annotations$Type.of.community.at.the.time.of.the.recordings[is.na(annotations$Type.of.community.at.the.time.of.the.recordings)]<-annotations$Naomi.community.type[is.na(annotations$Type.of.community.at.the.time.of.the.recordings)]

annotations$Type.of.community.at.the.time.of.the.recordings[annotations$Type.of.community.at.the.time.of.the.recordings %in% c("academic","capital city of the Soviet Union","city","industial","industrial ","work-for-pay",
                                                                                                                               "industrial & service &trade activities...","industrial city (3.000.000 inhabitants",
                                                                                                                               "Industrial city (population: around 272,000 inhabitants)",
                                                                                                                               "Mediterranean city of 1.6 million inhabitants",
                                                                                                                               "modern city families, usually both working parents",
                                                                                                                               "Orthodox Jews",
                                                                                                                               "Seaside tourist town",
                                                                                                                               "work-for-pay/industrial","industrial")]<-"urban"

annotations$Type.of.community.at.the.time.of.the.recordings[annotations$Type.of.community.at.the.time.of.the.recordings %in% c("farmer","rural","rural farming village")]<-"rural"

annotations$Type.of.community.at.the.time.of.the.recordings[annotations$Type.of.community.at.the.time.of.the.recordings %in% c("industrial, farmers")]<-"both"
#table(annotations$Type.of.community.at.the.time.of.the.recordings)
```



```{r ancillary data}
byPart<- annotations %>%
  select(Language.or.Languages.spoken.in.recordings, Number.of.participants) %>%
   filter(!is.na(Number.of.participants)) %>%
     group_by(Language.or.Languages.spoken.in.recordings) %>%
       summarise(numpar = sum(as.numeric(Number.of.participants))) 

read.csv("country_iso.csv")->iso_lookup
codes=iso_lookup$Code
iso_lookup$Name<-as.character(iso_lookup$Name)
iso_lookup$Name=gsub(", Islamic Republic of","",iso_lookup$Name)
iso_lookup$Name=gsub("Russian Federation","Russia",iso_lookup$Name)
iso_lookup$Name=gsub(", Province of China","",iso_lookup$Name)
iso_lookup$Name=gsub(", Republic of","",iso_lookup$Name)

names(codes)<-iso_lookup$Name


annotations$country_WB<-codes[annotations$country]

annotations$country_WB <-factor(annotations$country_WB)
annotations[is.na(annotations$country_WB),"country"]


annotations$continent <-factor(annotations$continent)


read.csv("wdi-data.csv")->dat_all

dat = dat_all[dat_all$iso2c %in% levels(annotations$country_WB),]


annotations=merge(annotations,dat_all,by="country",all.x=T)

# table(!is.na(annotations$SES.mid),!is.na(annotations$NY.GDP.PCAP.PP.KD))
# table(!is.na(annotations$Education.mid),!is.na(annotations$SE.SEC.CUAT.UP.ZS))
# table(!is.na(annotations$Type.of.community.at.the.time.of.the.recordings),!is.na(annotations$SP.URB.TOTL.ZS))
#             
# table(!is.na(annotations$Average.number.of.siblings),!is.na(annotations$SP.DYN.CEBN.Q3))

read.csv("children-born-per-woman-OWID-20220112.csv")->cpw

cpw[cpw$Year==2011,]->cpw
rcpw_all <- cpw %>% 
             group_by(Entity) %>%
             filter(Year == max(Year)) 
colnames(rcpw_all)[colnames(rcpw_all)=="Fertility.rate..Select.Gapminder..v12...2017."]<-"fertility"
annotations=merge(annotations,rcpw_all,by.x="country",by.y="Entity",all.x=T)

rcpw=rcpw_all[rcpw_all$Entity %in% levels(factor(annotations$country)),]

#TODO check no missing countries across WB & OWID merge
```

We had WDI information for `r dim(dat_all)[1]` countries, of which  `r dim(dat)[1]` were present in CHILDES. GDP data was available for `r sum(!is.na(dat_all$NY.GDP.PCAP.PP.KD))` countries overall, and `r sum(!is.na(dat$NY.GDP.PCAP.PP.KD))` countries in CHILDES. Education information was available for `r sum(!is.na(dat_all$SE.SEC.CUAT.UP.ZS))` countries overall, and `r sum(!is.na(dat$SE.SEC.CUAT.UP.ZS))` countries in CHILDES.  Information on the proportion of the population that was urban was available for `r sum(!is.na(dat_all$SP.URB.TOTL.ZS))` countries overall, and `r sum(!is.na(dat$SP.URB.TOTL.ZS))` countries in CHILDES. 

Fertility rate was obtained from Our World in Data, which had `r sum(!is.na(rcpw_all$fertility))` countries overall for the selected year, and `r sum(!is.na(rcpw$fertility))` of them were represented in CHILDES. 


## At the level of the population

The samples are varied in geographic terms, with corpora for every peopled continent. Specifically, `r sum(annotations$continent=="Africa")` corpora were collected in Africa; `r sum(annotations$continent=="Asia")` in Asia; `r sum(annotations$continent=="Western Europe")` in Western Europe, and a further `r sum(annotations$continent=="Non-Western Europe")` in Non-Western Europe; `r sum(annotations$continent=="North America")` in North America and `r sum(annotations$continent=="Western Europe")` in Latin America. Only `r sum(annotations$continent=="Oceania")` was collected in Oceania.

The samples, however, over-represent richer countries, with relatively educated populations, living mostly in urban settings, and having relatively small families (Figure XX).




```{r rich}

dens_dat=data.frame(rbind(cbind(dat_all$NY.GDP.PCAP.PP.KD[!is.na(dat_all$NY.GDP.PCAP.PP.KD)],0),
               cbind(dat$NY.GDP.PCAP.PP.KD[!is.na(dat$NY.GDP.PCAP.PP.KD)],1) ))
colnames(dens_dat)<-c("GDP.per.capita","in.childes_T")
dens_dat$in.childes=ifelse(dens_dat$in.childes,"CHILDES","all")

rich <- ggplot(dens_dat, aes(x = GDP.per.capita, fill = in.childes)) + geom_density(alpha = 0.5) + theme(legend.position = "none", axis.title.y=element_blank() ) +labs( x = "GDP per capita")

```



```{r Educated}
dens_dat=data.frame(rbind(cbind(dat_all$SE.SEC.CUAT.UP.ZS[!is.na(dat_all$SE.SEC.CUAT.UP.ZS)],0),
               cbind(dat$SE.SEC.CUAT.UP.ZS[!is.na(dat$SE.SEC.CUAT.UP.ZS)],1) ))
colnames(dens_dat)<-c("completed.HS","in.childes_T")
dens_dat$in.childes=ifelse(dens_dat$in.childes,"CHILDES","all")

ed <- ggplot(dens_dat, aes(x = completed.HS, fill = in.childes)) + geom_density(alpha = 0.5) + theme(legend.position = "none", axis.title.y=element_blank() )+labs( x = "Percent completed high school")


```




```{r urban}
dens_dat=data.frame(rbind(cbind(dat_all$SP.URB.TOTL.ZS[!is.na(dat_all$SP.URB.TOTL.ZS)],0),
               cbind(dat$SP.URB.TOTL.ZS[!is.na(dat$SP.URB.TOTL.ZS)],1) ))
colnames(dens_dat)<-c("pc.urban","in.childes_T")
dens_dat$in.childes=ifelse(dens_dat$in.childes,"CHILDES","all")

urb <- ggplot(dens_dat, aes(x = pc.urban, fill = in.childes)) + geom_density(alpha = 0.5) + theme(legend.position = "none", axis.title.y=element_blank() )+labs( x = "Percent urban")

```




```{r fertility}

dens_dat=data.frame(rbind(cbind(rcpw_all$fertility[!is.na(rcpw_all$fertility)],0),
               cbind(rcpw$fertility[!is.na(rcpw$fertility)],1) ))
colnames(dens_dat)<-c("N.children.woman","in.childes_T")
dens_dat$in.childes=ifelse(dens_dat$in.childes,"CHILDES","all")

fert <- ggplot(dens_dat, aes(x = N.children.woman, fill = in.childes)) + geom_density(alpha = 0.5)+ theme(legend.position = "none", axis.title.y=element_blank() ) +labs( x = "Total fertility rate")

```

```{r combined}

ggarrange(rich, ed, urb, fert,  
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2)
```


## At the level of the family

### Educated


We then investigated the extent to which samples themselves captured families with diverse educational backgrounds. There were `r sum(is.na(annotations$Education.Naomi))` missing values (`r round(sum(is.na(annotations$Education.Naomi))/length(annotations$Education.Naomi)*100)`%); and `r sum(annotations$Education.Naomi=="diverse")` were described as diverse, without clarifying the range of education covered. Of the remaining `r sum(!is.na(annotations$Education.min))` samples, `r sum(annotations$Education.min==1 & !is.na(annotations$Education.min))` had at least some parents with primary-level education; `r sum(annotations$Education.min==2 & !is.na(annotations$Education.min))` had parents with secondary school education as the lower bound, and a further `r sum(annotations$Education.min==3 & !is.na(annotations$Education.min))` had some college as the lower bound. Thus, the majority of the samples (N = `r sum(annotations$Education.min>3 & !is.na(annotations$Education.min))`, `r round(sum(annotations$Education.min>3 & !is.na(annotations$Education.min))/sum(!is.na(annotations$Education.min))*100)`%) portrayed children whose parents had a graduate or a post-graduate degree.

### Urban versus rural

Samples were also very homogeneous in terms of the type of community represented: `r sum(annotations$Type.of.community.at.the.time.of.the.recordings=="urban" & !is.na(annotations$Type.of.community.at.the.time.of.the.recordings))` (`r round(sum(annotations$Type.of.community.at.the.time.of.the.recordings=="urban" & !is.na(annotations$Type.of.community.at.the.time.of.the.recordings))/sum(!is.na(annotations$Type.of.community.at.the.time.of.the.recordings))*100)`% of the samples for which this variable was not missing) were described as industrialized or urban, and one additional one as both rural and urban. Only `r sum(annotations$Type.of.community.at.the.time.of.the.recordings!="urban" & !is.na(annotations$Type.of.community.at.the.time.of.the.recordings))` samples were described as farming or rural.


### Household structure

As for household structure, there was a great deal of missing data, with only `r  sum(!is.na(annotations$Household.structure))` (`r round(sum( !is.na(annotations$Household.structure))/length(annotations$Household.structure)*100)`%) of the samples specified. Among these, `r  sum(annotations$Household.structure=="nuclear" & !is.na(annotations$Household.structure))` (`r round(sum(annotations$Household.structure=="nuclear" & !is.na(annotations$Household.structure))/sum(!is.na(annotations$Household.structure))*100)`%) were nuclear; in `r  sum(annotations$Household.structure=="extended" & !is.na(annotations$Household.structure))` (`r round(sum(annotations$Household.structure=="extended" & !is.na(annotations$Household.structure))/sum(!is.na(annotations$Household.structure))*100)`%) were extended; and in one sample structure varied. 

### Siblings

It was not the case that the majority of children were single children. In fact, only `r sum(annotations$Proportion.With.Siblings==0 & !is.na(annotations$Proportion.With.Siblings))` samples (`r round(sum(annotations$Proportion.With.Siblings==0 & !is.na(annotations$Proportion.With.Siblings))/sum(!is.na(annotations$Proportion.With.Siblings))*100)`% of samples having information on siblings) were constituted exclusively by children with no siblings, and the remaining had at least some siblings. However, it should be born in mind that this variable was missing for `r sum(is.na(annotations$Proportion.With.Siblings))` samples (`r round(sum(is.na(annotations$Proportion.With.Siblings))/length(annotations$Proportion.With.Siblings)*100)`% of included samples).


- is WEIRD confounded in the world:
		- density plots (Western non Western): education, urban, rich, family size
		- correlation matrix: W/nW, education, urban, rich, family size
		- table
	- is WEIRD confounded in CHILDES
		- table: W/nW, urban,  education, has sibs (N of corpora)